<html>
<head>
    <meta charset="UTF-8">
    <title>检测区</title>
    <!-- bootstrap -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.css">
    <script src="https://cdn.bootcss.com/jquery/2.1.0/jquery.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.js"></script>
    <!-- awesome图标 -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.css">

    <!-- jquery-ui -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/jqueryui/1.12.1/jquery-ui.css">
    <script src="https://cdn.bootcss.com/jqueryui/1.12.1/jquery-ui.js"></script>

    <!-- treeview插件 -->
    <script src="https://cdn.bootcss.com/bootstrap-treeview/1.2.0/bootstrap-treeview.min.js"></script>

    <!-- bootstrap-switch -->
    <link href="https://cdn.bootcss.com/bootstrap-switch/4.0.0-alpha.1/css/bootstrap-switch.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/bootstrap-switch/4.0.0-alpha.1/js/bootstrap-switch.min.js"></script>

    <!-- nest样式 -->
    <link rel="stylesheet" href="../../standard/css/nest.css">
    <script src="../../standard/js/nest.js"></script>
    <!--建模数据相关js-->
    <script src="../../js/build-model/bulidModel.js"></script>
    <!--通用类js-->
    <script src="../../js/common/common.js"></script>
    <!--流程-->
    <script src="../../js/common/flow.js"></script>
    <!--region-->
    <script src="../../js/build-model/roi.js"></script>

    <style>
        form{
            padding: 5px;
        }
        .algorithm-param{
            display: none;
        }
        #collapse-button {
            position: absolute;
            top: 12px;
            right: 15px;
            z-index: 1000;
        }
        .absoluteCenter {
            left:0;
            right:0;
            top:0;
            bottom:0;
            margin: auto;
        }

        .well{
            padding: 10px;
        }
    </style>

    <script>
        // 工位树节点
        var treeNode = "";
        // 选中的树节点
        var selectedNode = "";
        // 分组索引
        var groupIndex = 1;
        // 对象索引
        var objectIndex = 1;
        // todo 算法路径
        var algorithmPath = "./../../FSQBM/QBM/PlugIns/";
        var language = "chinese";
        var paramLanguagePath = "./../../FSQBM/QBM/lang/"+language+"/";
        // 当前算法
        var currentAlgorithm = "";
        // 当前算法参数
        var algorithmParam = "";
        // WebSocket连接
        var ws = null;
        // 建模数据
        var buildModel = "";
        // 关联的对象图形
        var assocGraphs = [];

        $(document).ready(function(){
            // WebSocket连接
            if ("WebSocket" in window) {
                ws = new WebSocket("ws://localhost:8181");
                ws.onopen = function(){
                    console.log("websocket已连接");

                }
                ws.onmessage = function (e) {
                    var data = JSON.parse(e.data);
                    var clientType = data.header.clientType;
                    var command = data.body.command;
                    if(clientType=="IPUServer"){
                        if(command=="paramDebug"){
                            console.log("调试参数",data);
                            var debugParam = data.body.param.paramList;
                            updateParamValue(debugParam);
                        }
                    }
                }
            } else {
                // 浏览器不支持WebSocket
                alert("您的浏览器不支持 WebSocket!");
            }

            // 初始化
            // 获取session中的建模数据
            buildModel = JSON.parse(sessionStorage.getItem("buildModel"));
            console.log("buildModel : ",buildModel);
            // 初始化工位树
            treeNode = getStationTree(buildModel,false);
            console.log("treeNode",treeNode);
            $('#tree').treeview(treeNode);
            treeEvent();

            // 初始化算法列表
            var inspMethodList = buildModel.Product.InspMethodList;
            initAlgorithmSelect(inspMethodList);

            // 单击保存按钮
            $("#saveModel").on("click",function () {
                postJson(JSON.stringify(buildModel));
                console.log(JSON.stringify(buildModel));
            });

            // 单击退出按钮
            $("#quit").on("click",function(){
                var prePage = sessionStorage.getItem("prePage");
                window.location.href = "../build-model/build-model-index.html";
                /*if(prePage == "product-info"){
                    window.location.href = "../product-info/product-info.html";
                } else if (prePage == "product-detect"){
                    window.location.href = "../product-detect/product-detect.html";
                }*/
            });
            // 单击上一步按钮
            $("#prevStep").on("click",function(){
                // todo delete 将数据保存到session中
                sessionStorage.setItem("buildModel",JSON.stringify(buildModel));
                preFlow();
            });
            // 单击下一步按钮
            $("#nextStep").on("click",function(){
                // todo delete 将数据保存到session中
                sessionStorage.setItem("buildModel",JSON.stringify(buildModel));
                nextFlow();
            });

            setTreeContainerHeight();

            // 切换算法选择
            $("#algorithm-select").on("change",function () {
                // 清除关联对象标识区域
                if(assocGraphs.length != 0){
                    assocGraphs.forEach(function(graph){
                        clearContext("content",graph.coverageId);
                        drawGraph(graph);
                    });
                }
                assocGraphs = [];

                // 更新对象参数显示界面
                var methodId = $(this).val();
                var methodInfo = findInspMethodById(methodId);
                // 更新对象建模数据
                updateObjectBuildModel(methodInfo);
                // 更新对象关系数据
                var objectInfo = getObjectInfoBySelectedNode(selectedNode);
                console.log("objectInfo-----------",objectInfo);
                // 初期化对象关系数据
                initObjectAssoc(objectInfo);
                // 生成模板
                generateAlgorithmParam(methodInfo);
                // 更新树节点--对象节点
                updateObjectNode(methodId,translate(methodInfo.methodName,methodInfo.languageData));
            });

            // 更新对象节点检测方法名
            function updateObjectNode(methodId,methodName){
                var currentObjectNode = "";
                if(selectedNode.nodeType=="inspMethod"||selectedNode.nodeType=="region"){
                    currentObjectNode = $('#tree').treeview('getParent', selectedNode);
                } else if(selectedNode.nodeType=="object"){
                    currentObjectNode = selectedNode;
                }
                for(var i=0;i<treeNode.data.length;i++){
                    var stationNode = treeNode.data[i];
                    for(var j=0;j<stationNode.nodes.length;j++){
                        var refImageNode = stationNode.nodes[j];
                        for(var k=0;k<refImageNode.nodes.length;k++){
                            var groupNode = refImageNode.nodes[k];
                            for(var l=0;l<groupNode.nodes.length;l++){
                                var objectNode = groupNode.nodes[l];
                                if(objectNode.id==currentObjectNode.id){
                                    // 更新检测方法名
                                    objectNode.nodes[0].text=methodName;
                                    objectNode.nodes[0].methodId=methodId;
                                    console.log("objectNode------",objectNode);
                                }
                            }
                        }
                    }
                }
                $('#tree').treeview(treeNode);
                treeEvent();
            }

            // 单击调试按钮
            $("#paramDebug").on("click",function () {
                if(ws.readyState==WebSocket.OPEN){
                    var message = {
                        "header":{
                            "visionSysId":"",
                            "clientType":"ICW",
                            "version": "1.0.0"
                        },
                        "body":{
                            "command":"paramDebug",
                            "ipm":"",
                            "param":{
                                "inspMethodID":$("#algorithm-select").val(),
                                "paramList":algorithmParam.ParamList
                            }
                        }
                    }
                    ws.send(JSON.stringify(message));
                }else {
                    alert("未与IPUServer建立连接，请确认是否正确连接！");
                }
            });

            $('#collapse').on("click",function(){
                if($('#tree').treeview('getNode', 0).state.expanded){
                    $('#tree').treeview('collapseAll');
                    $('#collapse').find("i").attr("class","fa fa-plus");
                } else {
                    $('#tree').treeview('expandAll');
                    $('#collapse').find("i").attr("class","fa fa-minus");
                }
            });


            // 点击新增分组按钮
            $("#addGroup").on("click",function () {
                // selectedNode为参考图节点
                selectedNode.state.expanded = true;
                selectedNode.state.selected = false;
                // 工位节点
                var currentWorkStationNode = $('#tree').treeview('getParent', selectedNode);
                console.log("CurrentWorkStationNode",currentWorkStationNode);

                // 分组信息
                var groupInfo = {
                    ID:groupIndex,
                    Name:"分组#"+groupIndex,
                    WorkStationID:currentWorkStationNode.id,
                    RefImageID:selectedNode.id
                }

                if(selectedNode.nodes){
                    selectedNode.nodes.push(
                            {
                                id:groupInfo.ID,
                                text: groupInfo.Name,
                                icon: "fa fa-sitemap",
                                nodeType: "group",
                                state: {
                                    selected: true
                                },
                                nodes:[],
                                parents:[groupInfo.WorkStationID,groupInfo.RefImageID]
                            }
                    );
                } else {
                    selectedNode.nodes = [{
                        id: groupInfo.ID,
                        text: groupInfo.Name,
                        icon: "fa fa-sitemap",
                        nodeType: "group",
                        state:{
                            selected: true
                        },
                        nodes:[],
                        parents:[groupInfo.WorkStationID,groupInfo.RefImageID]
                    }];
                }

                // 分组索引+1
                groupIndex++;

                $('#tree').treeview(treeNode);
                treeEvent();
                selectedNode = $('#tree').treeview('getSelected')[0];
                // 显示分组工具栏
                $("#imageToolbar").css("display","none");
                $("#groupToolbar").css("display","block");
                $("#objectToolbar").css("display","none");

                // 新增分组建模数据
                addGroupBuildModel(groupInfo);
            });

            // 点击删除分组按钮
            $("#deleteGroup").on("click",function () {
                // 当前参考图节点
                var currentImageNode = $('#tree').treeview('getParent', selectedNode);

                var selectedGroupIndex = 0;
                // 遍历分组
                for(var i=0;i<currentImageNode.nodes.length;i++){
                    if(currentImageNode.nodes[i].nodeId == selectedNode.nodeId){
                        selectedGroupIndex = i;
                    }
                }
                // 从参考图节点中删除该分组节点
                currentImageNode.nodes.splice(selectedGroupIndex,1);
                currentImageNode.state.selected = true;
                console.log("deletedImageNode",currentImageNode);

                // 删除分组建模数据
                deleteGroupBuildModel(selectedNode);

                $('#tree').treeview(treeNode);
                treeEvent();
                selectedNode = $('#tree').treeview('getSelected')[0];
                // 显示对象工具栏
                $("#imageToolbar").css("display","block");
                $("#groupToolbar").css("display","none");
                $("#objectToolbar").css("display","none");
            });

            // 点击新增对象按钮
            $("#addObject").on("click",function () {
                // 新增对象
                addObject(null);
            });

            // 点击删除对象按钮
            $("#deleteObject").on("click",function () {
                // 删除对象
                deleteObject();
                // 删除图形
                deleteGraph();
            });

            
            // 点击折叠按钮
            $("#collapse-button").on("click",function(){
                if($(this).find("i").attr("class")=="fa fa-angle-double-right"){
                    hideRightContent();
                } else {
                    showRightContent();
                }
            });

            /*对象、region相关---start----------------------------------------*/

            // 初始化绘制模板图像
            initPic("./../../product/test/Station1-C1-0.bmp");

            var interval = setInterval(function(){
                if(options){
                    // 获取所有的region(一定要在初始化图像之后)
                    graphList = getGraphList();
                    // 绘制图形
                    drawRegions(graphList);
                    clearInterval(interval);
                }
            },50);

            // 绘制矩形
            $("#newSquare").on("click",function () {
                if(checkAddRoi()){
                    mouseDraft("newROI","square");
                }
            });
            // 绘制多边形
            $("#newPolygon").on("click",function () {
                if(checkAddRoi()){
                    mouseDraft("newROI","polygon");
                }
            });
            // 选择ROI
            $("#selectRoi").on("click",function () {
                // 图形：选中
                selectGraph();

            });
            // 删除region
            $("#deleteRoi").on("click",function () {
                if (previousSelectedGraph != null) {
                    deleteGraph();
                    deleteObject();
                } else {
                    alert("未选中任何图形！");
                }
            });

            // 缩放：原图大小
            $("#fitOrigin").on("click",function () {
                zoomPic("origin");
            });
            // 缩放：适应高度
            $("#fitHeight").on("click",function () {
                zoomPic("height");
            });
            // 缩放：适应宽度
            $("#fitWidth").on("click",function () {
                zoomPic("width");
            });
            // 缩放：适应窗口
            $("#fitWindow").on("click",function () {
                zoomPic("window");
            });
            // 缩放：放大
            $("#zoomIn").on("click",function () {
                zoomPic("zoom-in");
            });
            // 缩放：缩小
            $("#zoomOut").on("click",function () {
                zoomPic("zoom-out");
            });

            /*对象、region相关---end------------------------------------------*/
        });

        $(window).resize(function () {
            setTreeContainerHeight();
        });

        // 工具提示
        $(function () {
            $('.btnTooltip').tooltip();
        })

        function setTreeContainerHeight() {
            var btnGroupHeight = $('#btnToolbar').height();
            var treeContainerHeight = $('#treeContainer').parent().height();
            $('#treeContainer').height(treeContainerHeight-btnGroupHeight);
        }

        // 工位树事件
        function treeEvent() {
            // 点击工位树节点
            $('#tree').on('nodeSelected', function(event, data) {
                selectedNode = $('#tree').treeview('getSelected')[0];
                afterSelecttreeNode();
                // 选中节点对应的region
                selectROI();
                // 标识关联对象区域
                markAssocRegion(selectedNode);
            });
        }

        // 树节点选中后的处理
        function afterSelecttreeNode(){
            $("#imageToolbar").css("display","none");
            $("#groupToolbar").css("display","none");
            $("#objectToolbar").css("display","none");

            if(selectedNode.nodeType == "workStation"){
                hideRightContent();
            }else if(selectedNode.nodeType == "refImage"){
                $("#imageToolbar").css("display","block");
                hideRightContent();
            } else if(selectedNode.nodeType == "group"){
                $("#groupToolbar").css("display","block");
                hideRightContent();
            } else if(selectedNode.nodeType == "object"){
                // 显示对象工具按钮
                $("#objectToolbar").css("display","block");
                // 显示算法参数界面
                showRightContent();

                // 更新算法参数界面
                var ids = [];
                $.extend(true,ids,selectedNode.parents);
                ids.push(selectedNode.id);
                var methodInfo = findInspMethod(ids);
                generateAlgorithmParam(methodInfo);
                $("#algorithm-select").val(selectedNode.nodes[0].methodId);
                // 更新界面对象名
                $("#objectName").html(selectedNode.text);
            } else if(selectedNode.nodeType == "inspMethod"||selectedNode.nodeType == "region"){
                // 显示算法参数界面
                showRightContent();

                // 对象节点
                var objectNode = $('#tree').treeview('getParent', selectedNode);
                // 更新算法参数界面
                var methodInfo = findInspMethod(selectedNode.parents);
                generateAlgorithmParam(methodInfo);
                $("#algorithm-select").val(objectNode.nodes[0].methodId);
                // 更新界面对象名
                $("#objectName").html(objectNode.text);
            }
        }

        // 选中ROI
        function selectROI(){
            // 对象及其所有父节点id
            var objIds = [];
            $.extend(true,objIds,selectedNode.parents);
            var currentObject;
            if(selectedNode.nodeType == "object"){
                objIds.push(selectedNode.id);

                currentObject = findObjectInArray(buildModel.Product.WorkStationList,objIds);
                // 选中当前对象region
                if(currentObject.RegionIDList.length!=0){
                    selectGraphById(currentObject.RegionIDList[0].ID);
                }
            } else if(selectedNode.nodeType == "inspMethod"||selectedNode.nodeType == "region"){
                currentObject = findObjectInArray(buildModel.Product.WorkStationList,objIds);
                // 选中当前对象region
                if(currentObject.RegionIDList.length!=0){
                    selectGraphById(currentObject.RegionIDList[0].ID);
                }
            } else { // 取消选中
                unSelectGraph();
            }
        }

        // 标识关联对象区域
        function markAssocRegion(selectedNode) {
            // 清除关联对象标识区域
            if(assocGraphs.length != 0){
                assocGraphs.forEach(function(graph){
                    clearContext("content",graph.coverageId);
                    drawGraph(graph);
                });
            }
            assocGraphs = [];

            // 对象及其父节点id
            var objIds = [];
            $.extend(true,objIds,selectedNode.parents);
            if(selectedNode.nodeType == "object"){
                objIds.push(selectedNode.id);
            }else if(selectedNode.nodeType == "inspMethod"||selectedNode.nodeType == "region"){

            }else {
                return;
            }

            // 当前参考图下所有对象信息
            var objectList = getAllObject(selectedNode);
            var regionIds = [];
            // 获取算法关系值
            var assocValues = getObjectAssocValue(objIds);
            for(var i=0;i<assocValues.length;i++){
                for(var j=0;j<objectList.length;j++){
                    if(assocValues[i] == objectList[j].Attribute.ID){
                        regionIds.push(objectList[j].RegionIDList[0].ID);
                        break;
                    }
                }
            }

            // 标识关联对象区域
            for(var i=0;i<regionIds.length;i++){
                for(j=0;j<graphList.length;j++){
                    if(regionIds[i] == graphList[j].id){
                        // 以标识色填充重绘
                        drawGraph(graphList[j],null,"255,215,0");
                        assocGraphs.push(graphList[j]);
                        break;
                    }
                }
            }
        }

        // 新增对象
        function addObject(regionID){

            // 当前分组id
            var groupId = "";
            var ids = [selectedNode.parents[0],selectedNode.parents[1]];

            // 当前选中的节点是分组
            if(selectedNode.nodeType=="group"){
                groupId = selectedNode.id;
            } else if(selectedNode.nodeType=="object"){ // 当前选中的节点是对象
                groupId = selectedNode.parents[2];
            } else if(selectedNode.nodeType=="inspMethod"){ // 当前选中的节点是对象检测方法
                groupId = selectedNode.parents[2];
            }

            ids.push(groupId);

            // 当前分组节点
            var currentGroupNode = findNodeInTreeNode(ids);

            // 当前参考图建模数据
            var buildModelImageData = findImgInbuildModel(selectedNode.parents[1]);
            // 获取默认检测算法
            var defaultInspID = buildModelImageData.Attribute.DefaultInspID;
            var methodInfo = findInspMethodById(defaultInspID);
            console.log("methodInfo",methodInfo);
            // 翻译算法名
            var methodName = translate(methodInfo.methodName,methodInfo.languageData);

            var regionIDList = [];
            if(regionID!=null||regionID!=undefined){
                regionIDList.push({
                    ID:regionID
                });
            }
            // 对象信息
            var objectInfo = {
                ID:objectIndex,
                Name:"对象#"+objectIndex,
                WorkStationID:selectedNode.parents[0],
                RefImageID:selectedNode.parents[1],
                GroupID:groupId,
                InspMethodID:defaultInspID,
                RegionIDList:regionIDList,
                ParamList:methodInfo.paramList
            }

            // 对象树节点
            var objectNode = {
                id: objectInfo.ID,
                text: objectInfo.Name,
                icon: "fa fa-cube",
                nodeType: "object",
                parents:[objectInfo.WorkStationID,objectInfo.RefImageID,objectInfo.GroupID],
                state: {
                    expanded:true,
                    selected: true
                },
                nodes:[
                    {
                        text: methodName,
                        icon: "fa fa-gear",
                        nodeType: "inspMethod",
                        methodId: defaultInspID,
                        parents:[objectInfo.WorkStationID,objectInfo.RefImageID,objectInfo.GroupID,objectInfo.ID]
                    },
                    {
                        text: "region",
                        icon: "fa fa-pencil-square-o",
                        nodeType:"region",
                        parents:[objectInfo.WorkStationID,objectInfo.RefImageID,objectInfo.GroupID,objectInfo.ID]
                    }
                ]
            };

            selectedNode.state.selected = false;
            currentGroupNode.state.expanded = true;
            currentGroupNode.state.selected = false;
            currentGroupNode.nodes.push(objectNode);
            objectIndex++;

            $('#tree').treeview(treeNode);
            treeEvent();
            selectedNode = $('#tree').treeview('getSelected')[0];
            // 显示对象工具栏
            $("#imageToolbar").css("display","none");
            $("#groupToolbar").css("display","none");
            $("#objectToolbar").css("display","block");

            $("#algorithm-select").val(defaultInspID);
            // 生成算法参数界面
            generateAlgorithmParam(methodInfo);
            // 显示算法参数界面
            showRightContent();

            // 新增对象建模数据
            addObjectBuildModel(objectInfo);
            // 新增对象关系数据
            initObjectAssoc(objectInfo);
        }

        // 删除对象
        function deleteObject(){
            // 当前对象信息
            var objectInfo = getObjectInfoBySelectedNode(selectedNode);
            // 删除对象关系数据
            deleteObjectAssoc(objectInfo);
            // 删除对象建模数据
            deleteObjectBuildModel(selectedNode);

            if(selectedNode.nodeType!="region"){
                // 更新树节点与显示
                var objectId;
                var groupIds;
                if(selectedNode.nodeType=="object"){
                    objectId = selectedNode.id;
                    groupIds = selectedNode.parents;
                } else{
                    objectId = selectedNode.parents[3];
                    groupIds = [selectedNode.parents[0],selectedNode.parents[1],selectedNode.parents[2]];
                }
                // 当前分组节点
                var currentGroupNode = findNodeInTreeNode(groupIds);

                var selectedObjectIndex = 0;
                // 遍历对象
                for(var i=0;i<currentGroupNode.nodes.length;i++){
                    if(currentGroupNode.nodes[i].id == objectId){
                        selectedObjectIndex = i;
                    }
                }
                // 从对象list中删除该对象
                currentGroupNode.nodes.splice(selectedObjectIndex,1);
                currentGroupNode.state.selected = true;

                // 更新工位树显示
                $('#tree').treeview(treeNode);
                treeEvent();
                selectedNode = $('#tree').treeview('getSelected')[0];

                // 显示对象工具栏
                $("#imageToolbar").css("display","none");
                $("#groupToolbar").css("display","block");
                $("#objectToolbar").css("display","none");

                // 标识关联对象区域
                markAssocRegion(selectedNode);
            }
        }

        // 初始化算法选择下拉框
        function initAlgorithmSelect(inspMethodList) {
            var $algorithmSelect = $("#algorithm-select");
            var option = "";
            var languageData = "";
            for(var i=0;i<inspMethodList.length;i++){
                var methodId = inspMethodList[i].Attribute.ID;
                var methodName = inspMethodList[i].Attribute.Name;
                languageData = getLanguageData(paramLanguagePath+methodName+".json",language)
                        .Translation.Module.LangItem;
                var methadDispName = translate(methodName,languageData);
                option+='<option value="'+methodId+'">'+methadDispName+'</option>';
            }
            $algorithmSelect.append(option);
        }

        // 获取算法语言翻译
        function getLanguageData(path,language) {
            var data = "";
            if(language=="chinese"){
                var temp = path.split(".json");
                data = getJson(temp[0]+"_ch.json",false);
            }
            return data;
        }

        // 生成检测算法参数界面
        function generateAlgorithmParam(methodInfo){
            // 算法参数信息
            var paramList = methodInfo.paramList;
            // 算法语言信息
            var languageData = methodInfo.languageData;
            // 算法关系信息
            var assocList = buildModel.Product.AssocList;

            // 基础参数下拉
            var $basicDropdownMemu = $("#basic-dropdown-menu");
            // 高级参数下拉
            var $advanceDropdownMemu = $("#advance-dropdown-menu");
            // 仿真结果参数
            var $debugParamContainer = $("#debugParam");
            // 算法关系
            var $assocContainer = $("#assocContainer");
            // tab内容主体
            var $tabContent = $("#tab-content");

            // 清空
            $debugParamContainer.empty();
            $assocContainer.empty();
            $basicDropdownMemu.empty();
            $advanceDropdownMemu.empty();
            $(".dropDownContent").remove();

            // 获取关联的算法信息
            var assocInfoList = getAssocInfo(methodInfo.methodId,assocList);
            if(assocInfoList.length == 0){
                $assocContainer.prop('hidden',true);
            } else {
                $assocContainer.prop('hidden',false);
            }

            // 当前参考图下所有对象信息
            var objectList = getAllObject(selectedNode);

            // 循环生成算法关系内容
            for(var i=0;i<assocInfoList.length;i++){
                var assocInfo = assocInfoList[i];
                var id = assocInfo.id;
                var methodId = assocInfo.methodId;
                var methodName = assocInfo.methodName;
                var option='<option value="-1"></option>';
                var assocValue = "-1";
                if(methodInfo.assocValues){
                    assocValue = methodInfo.assocValues[i];
                }

                objectList.forEach(function (object) {
                    if(id == object.Attribute.InspMethodID){
                        if(assocValue == object.Attribute.ID){
                            option+='<option value="'+object.Attribute.ID+'" selected>'+object.Attribute.Name+'</option>';
                        }else{
                            option+='<option value="'+object.Attribute.ID+'">'+object.Attribute.Name+'</option>';
                        }
                    }
                });

                var model = '<div class="form-group">' +
                        '<label class="col-sm-4 control-label nest-sm-col">'+methodName+'</label>' +
                        '<div class="col-sm-6 nest-sm-col">' +
                        '<select class="form-control" id="'+i+'" value="'+assocValue+'" onchange="updateObjectAssoc(this)">'+option+'</select>' +
                        '</div>' +
                        '<div class="col-sm-2 nest-sm-col"><button type="button" class="btn btn-primary btn-sm" id="selectAssoc-'+i+'" onclick="selectAssoc(this)"><i class="fa fa-search"></i></button></div>' +
                        '</div>';

                $assocContainer.append(model);
            }

            var basicCategoryIdList = [];
            var advanceCategoryIdList = [];

            // 循环生成算法参数内容
            for(var i=0;i<paramList.length;i++){
                var paramItem = paramList[i];
                var id = paramItem.Name;
                var paramName = translate(id,languageData);
                var defaultValue = paramItem.Value;
                var tip = translate(paramItem.Tips,languageData);
                var type = paramItem.Type;
                var dispEnable = paramItem.DispEnable;
                var modifyEnable = paramItem.ModifyEnable;

                if(dispEnable==0){
                    continue;
                }

                // 0：算法参数 -1：仿真结果参数
                var classifyValue = paramItem.ClassifyValue;
                // 1：基础参数 2：高级参数
                var authority = paramItem.Authority;

                // 参数分类
                var categoryId = paramItem.Label;
                var categoryName = translate(categoryId,languageData);
                // 基础参数
                if(authority=="1"){
                    if(categoryId){
                        categoryId = categoryId+"-basic";
                        if(basicCategoryIdList.indexOf(categoryId) == -1){
                            if(basicCategoryIdList.length ==0){
                                // 新增分类下拉tab
                                $basicDropdownMemu.append('<li class="active"><a href="#'+categoryId+'" tabindex="-1" data-toggle="tab">'+categoryName+'</a></li>');
                                // 新增tabContent
                                $tabContent.append('<div role="tabpanel" class="tab-pane dropDownContent active" id="'+categoryId+'"></div>');
                            } else {
                                // 新增分类下拉tab
                                $basicDropdownMemu.append('<li><a href="#'+categoryId+'" tabindex="-1" data-toggle="tab">'+categoryName+'</a></li>');
                                // 新增tabContent
                                $tabContent.append('<div role="tabpanel" class="tab-pane dropDownContent" id="'+categoryId+'"></div>');
                            }
                            basicCategoryIdList.push(categoryId);
                        }
                    }
                }

                // 高级参数
                if(authority=="2"){
                    if(categoryId){
                        categoryId = categoryId+"-advance";
                        if(advanceCategoryIdList.indexOf(categoryId) == -1){
                            // 新增分类下拉tab
                            $advanceDropdownMemu.append('<li><a href="#'+categoryId+'" tabindex="-1" data-toggle="tab">'+categoryName+'</a></li>');
                            // 新增tabContent
                            $tabContent.append('<div role="tabpanel" class="tab-pane dropDownContent" id="'+categoryId+'"></div>');
                            advanceCategoryIdList.push(categoryId);
                        }
                    }
                }

                var model="";
                // 文本框
                if(type=="1"||type=="2"){
                    model='<div class="form-group">' +
                            '<label class="col-sm-6 control-label">'+paramName+'</label>' +
                            '<div class="col-sm-6">' +
                            '<input type="text" class="form-control" id="'+id+'" value="'+defaultValue+'" title="'+tip+'" onchange="updateParam(this)">' +
                            '</div>' +
                            '</div>';
                } else if(type=="3"){// checkbox
                    if(defaultValue == 1){
                        model='<div class="form-group"><label class="col-sm-12">' +
                                '<input type="checkbox" checked id="'+id+'" value="'+defaultValue+'" title="'+tip+'" onchange="updateParam(this)" onclick="this.value=(this.value==0)?1:0"> ' + paramName+'</label></div>';
                    }else{
                        model='<div class="form-group"><label class="col-sm-12">' +
                                '<input type="checkbox" id="'+id+'" value="'+defaultValue+'" title="'+tip+'" onchange="updateParam(this)" onclick="this.value=(this.value==0)?1:0"> ' + paramName+'</label></div>';
                    }

                } else if(type=="4"){ // 浮点型数字
                    var ranges = paramItem.Range.split("%%");
                    var minValue = ranges[0];
                    var maxValue = ranges[1];
                    model='<div class="form-group">' +
                            '<label class="col-sm-6 control-label">'+paramName+'</label>' +
                            '<div class="col-sm-6">' +
                            '<input type="number" class="form-control" id="'+id+'" value="'+defaultValue+'" min="'+minValue+'" max="'+maxValue+'" step="0.1" onchange="updateParam(this)"/>' +
                            '</div>' +
                            '</div>';
                } else if(type=="5") { // 整数
                    var ranges = paramItem.Range.split("%%");
                    var minValue = ranges[0];
                    var maxValue = ranges[1];
                    model='<div class="form-group">' +
                            '<label class="col-sm-6 control-label">'+paramName+'</label>' +
                            '<div class="col-sm-6">' +
                            '<input type="number" class="form-control" id="'+id+'" value="'+defaultValue+'" min="'+minValue+'" max="'+maxValue+'" onchange="updateParam(this)"/>' +
                            '</div>' +
                            '</div>';
                } else if(type=="6"||type=="7"||type=="8"){// 下拉框
                    var options = paramItem.Range.split("%%");
                    var option="";
                    for(var j=0;j<options.length;j++){
                        if(defaultValue == options[j]){
                            option+='<option value="'+options[j]+'" selected>'+options[j]+'</option>';
                        } else {
                            option+='<option value="'+options[j]+'">'+options[j]+'</option>';
                        }
                    }
                    model='<div class="form-group">' +
                            '<label class="col-sm-6 control-label">'+paramName+'</label>' +
                            '<div class="col-sm-6">' +
                            '<select class="form-control" id="'+id+'" value="'+defaultValue+'" title="'+tip+'" onchange="updateParam(this)">'+option+'</select>' +
                            '</div></div>';
                } else if(type=="10"){ // range
                    var ranges = paramItem.Range.split("%%");
                    var minValue = ranges[0];
                    var maxValue = ranges[1];
                    model='<div class="form-group">' +
                            '<label class="col-sm-4 control-label nest-sm-col">'+paramName+'</label>' +
                            '<div class="col-sm-5 nest-sm-col">' +
                            '<input type="range" class="form-control" id="'+id+'-slider" value="'+defaultValue+'"  min="'+minValue+'" max="'+maxValue+'" title="'+tip+'" onchange="updateParam(this)">' +
                            '</div>' +
                            '<div class="col-sm-3 nest-sm-col">' +
                            '<input type="number" class="form-control" id="'+id+'-spinner" value="'+defaultValue+'" min="'+minValue+'" max="'+maxValue+'" style="width: 50px;" onclick="updateParam(this)"/>' +
                            '</div></div>';

                }
                // 仿真结果参数
                if(classifyValue=="-1"){
                    $debugParamContainer.append(model);
                } else { // 算法参数
                    var $paramContainer = eval('$("#'+categoryId+'")');
                    $paramContainer.append(model);
                }
            }
        }

        // 获取关联的算法信息
        function getAssocInfo(objectMethodId,assocList) {
            var inspMethodList = buildModel.Product.InspMethodList;
            var assocInfoList = new Array;
            assocList.forEach(function(assocItem){
                if(assocItem.MainNode.Attribute.ID == objectMethodId){
                    assocItem.SubNode.forEach(function (subNode) {
                        var id = subNode.Attribute.ID;
                        var methodId = getMethodId(inspMethodList,id);
                        var methodName = getMethodName(methodId);
                        assocInfoList.push({
                            id:id,
                            methodId:methodId,
                            methodName:methodName
                        });
                    });
                }
            });

            return assocInfoList;

            // 获取算法名称
            function getMethodId(inspMethodList,id) {
                for(var i= 0;i<inspMethodList.length;i++){
                    if(inspMethodList[i].Attribute.ID == id){
                        return inspMethodList[i].Attribute.Name;
                    }
                }
            }

            // 获取算法名称翻译名（显示名称）
            function getMethodName(methodId){
                // 获取翻译语言信息
                var languageData = getLanguageData(paramLanguagePath+methodId+".json",language)
                        .Translation.Module.LangItem;
                return translate(methodId,languageData);
            }
        }

        // 当前参考图下所有对象信息
        function getAllObject(selectedNode) {
            var currentImg = findObjectInArray(buildModel.Product.WorkStationList,[selectedNode.parents[0],selectedNode.parents[1]]);
            var objectList = new Array();
            currentImg.GroupList.forEach(function(group){
                group.InspObjList.forEach(function (inspObj) {
                    objectList.push(inspObj);
                });
            });
            return objectList;
        }

        // 获取翻译
        function translate(src,dic){
            var result=src;
            for(var i=0;i<dic.length;i++){
                if(src==dic[i].Src){
                    result = dic[i].Dst;
                    return result;
                }
            }
        }
        
        // 根据参数信息更新界面参数值
        function updateParamValue(paramList) {
            for(var i=0;i<paramList.length;i++){
                $("#"+paramList[i].Name).val(paramList[i].Value);
            }
        }

        // 在建模数据中查找指定参考图
        function findImgInbuildModel(imgId){
            for(var i=0;i<buildModel.Product.WorkStationList.length;i++){
                var workStation = buildModel.Product.WorkStationList[i];
                for(var j=0;j<workStation.RefImageList.length;j++){
                    var refImage = workStation.RefImageList[j];
                    if(refImage.Attribute.ID==imgId){
                        return refImage;
                    }
                }
            }
        }

        // 获取指定的检测方法
        function findInspMethod(objIds) {
            var inspObj = findObjectInArray(buildModel.Product.WorkStationList,objIds);
            var methodId = inspObj.Attribute.InspMethodID;
            var methodName = "";
            for(var i=0;i<buildModel.Product.InspMethodList.length;i++){
                var inspMethod = buildModel.Product.InspMethodList[i];
                if(inspMethod.Attribute.ID==methodId){
                    methodName = inspMethod.Attribute.Name;
                    break;
                }
            }

            var inspMethodFileName = inspMethod.Attribute.Name+".json";
            // 获取翻译语言信息
            var languageData = getLanguageData(paramLanguagePath+inspMethodFileName,language)
                    .Translation.Module.LangItem;
            var paramList = inspObj.ParamList;

            // 获取算法关系值
            var assocValues = getObjectAssocValue(objIds);

            return {
                methodId:methodId,
                methodName:methodName,
                paramList:paramList,
                languageData:languageData,
                assocValues:assocValues
            }
        }

        // 获取对象的关联对象id
        function getObjectAssocValue(objIds){
            var objectId = objIds[objIds.length-1];
            // 获取算法关系值
            var assocValues = new Array();
            // 当前分组下的对象关系
            var objectAssocList = findObjectInArray(buildModel.Product.WorkStationList,[objIds[0],objIds[1],objIds[2]]).AssocList;
            // 遍历获取算法关系值
            for(var i=0;i<objectAssocList.length;i++){
                if(objectId == objectAssocList[i].MainNode.Attribute.ID){
                    for(var j=0;j<objectAssocList[i].SubNode.length;j++){
                        assocValues.push(objectAssocList[i].SubNode[j].Attribute.ID);
                    }
                    break;
                }
            }
            return assocValues;
        }

        // 根据检测方法id获取指定的检测方法
        function findInspMethodById(id) {
            var methodName = "";
            for(var i=0;i<buildModel.Product.InspMethodList.length;i++){
                var inspMethod = buildModel.Product.InspMethodList[i];
                if(inspMethod.Attribute.ID==id){
                    methodName = inspMethod.Attribute.Name;
                    break;
                }
            }

            var inspMethodFileName = inspMethod.Attribute.Name+".json";
            // 获取算法参数信息
            algorithmParam = getJson(algorithmPath+inspMethodFileName,false);
            // 获取翻译语言信息
            var languageData = getLanguageData(paramLanguagePath+inspMethodFileName,language)
                    .Translation.Module.LangItem;
            return {
                methodId:id,
                methodName:methodName,
                paramList:algorithmParam.ParamList,
                languageData:languageData
            }
        }


        // 新增分组建模数据
        function addGroupBuildModel(groupInfo){
            var group = {
                Attribute:{
                    ID:"",
                    Name:"",
                    Level:"0",
                    WorkStationID:"",
                    RefImageID:""
                },
                AssocList:[],
                RegionList:[],
                InspObjList:[]
            }
            group.Attribute = groupInfo;

            // 更新建模数据
            var groupList = findObjectInArray(
                    buildModel.Product.WorkStationList,
                    [groupInfo.WorkStationID,groupInfo.RefImageID]).GroupList;
            groupList.push(group);
        }

        // 删除分组建模数据
        function deleteGroupBuildModel(selectedNode){
            var groupList = findObjectInArray(buildModel.Product.WorkStationList,selectedNode.parents).GroupList;
            var targetIndex = 0;
            var targetGroup;
            for(var i=0;i<groupList.length;i++){
                if(groupList[i].Attribute.ID == selectedNode.id){
                    targetGroup = groupList[i];
                    targetIndex = i;
                }
            }
            // 删除分组数据
            groupList.splice(targetIndex,1);

            // 删除分组下的region
            var regionList = targetGroup.RegionList;
            regionList.forEach(function(region){
                deleteGraphById(region.Attribute.ID);
            });
        }

        // 新增对象建模数据
        function addObjectBuildModel(objectInfo){
            var object = {
                Attribute:{
                    ID:"",
                    Name:"",
                    WorkStationID:"",
                    RefImageID:"",
                    CamImageID:"",
                    GroupID:"",
                    InspMethodID:""
                },
                RegionIDList:objectInfo.RegionIDList,
                ParamList:objectInfo.ParamList
            }
            object.Attribute = objectInfo;

            // 更新建模数据
            var inspObjList = findObjectInArray(
                    buildModel.Product.WorkStationList,
                    [objectInfo.WorkStationID,objectInfo.RefImageID,objectInfo.GroupID]).InspObjList;
            inspObjList.push(object);
        }

        // 更新对象建模数据
        function updateObjectBuildModel(methodInfo){
            var ids = [];
            if(selectedNode.nodeType=="object"){
                $.extend(true,ids,selectedNode.parents);
                ids.push(selectedNode.id);
            }else{
                $.extend(true,ids,selectedNode.parents);
            }

            var inspObject = findObjectInArray(buildModel.Product.WorkStationList,ids);
            inspObject.Attribute.InspMethodID = methodInfo.methodId;
            inspObject.ParamList = methodInfo.paramList;
        }

        // 初始化对象关系数据
        function initObjectAssoc(objectInfo){
            // 产品算法关系
            var methodAssocList = buildModel.Product.AssocList;
            // 当前分组下的对象关系
            var objectAssocList = findObjectInArray(buildModel.Product.WorkStationList,[objectInfo.WorkStationID,objectInfo.RefImageID,objectInfo.GroupID]).AssocList;
            // 关系id
            var assocId;
            if(objectAssocList.length == 0){
                assocId = 1
            } else {
                assocId = parseInt(objectAssocList[objectAssocList.length-1].Attribute.ID)+1;
            }

            // 获取当前对象算法的assocItem
            var currentObjectMethodAssoc;
            for(var i=0;i<methodAssocList.length;i++){
                if(objectInfo.InspMethodID == methodAssocList[i].MainNode.Attribute.ID){
                    currentObjectMethodAssoc = methodAssocList[i];
                    break;
                }
            }

            // 根据算法关系定义对象关系的subNode
            var subNode = new Array();
            if(currentObjectMethodAssoc){
                for(var i=0;i<currentObjectMethodAssoc.SubNode.length;i++){
                    subNode.push({
                        Attribute:{
                            ID:"-1",
                            Name:"",
                            Extra:"",
                            Type:"1"
                        }
                    });
                }
            }else{
                subNode.push({
                    Attribute:{
                        ID:"-1",
                        Name:"",
                        Extra:"",
                        Type:"1"
                    }
                });
            }

            // 新增对象的assocItem
            var objectAssoc = {
                Attribute:{
                    ID:assocId,
                    Name:"",
                    Enable: "1",
                    Type: "1"
                },
                MainNode:{
                    Attribute:{
                        ID:objectInfo.ID,
                        Name:"",
                        Extra:"",
                        Type:"1"
                    }
                },
                SubNode:subNode
            }

            var isNewObject = true;
            // 更新分组对象关系列表
            for(var i=0;i<objectAssocList.length;i++){
                if(objectInfo.ID == objectAssocList[i].MainNode.Attribute.ID){
                    objectAssocList[i] = objectAssoc;
                    isNewObject = false;
                    break;
                }
            }
            if(isNewObject){ // 添加到当前分组的对象关系列表中
                objectAssocList.push(objectAssoc);
            } else {
                // 检查当前对象有没有作为其他对象的输入，若有，则让其他对象输入更新为无效
                checkObjectAssocList();
            }

            // 检查当前对象有没有作为其他对象的输入，若有，则让其他对象输入更新为无效
            function checkObjectAssocList(){
                for(var i=0;i<objectAssocList.length;i++){
                    for(var j=0;j<objectAssocList[i].SubNode.length;j++){
                        if(objectInfo.ID == objectAssocList[i].SubNode[j].Attribute.ID){
                            objectAssocList[i].SubNode[j].Attribute.ID = -1;
                        }
                    }
                }
            }
        }

        // 删除对象关系数据
        function deleteObjectAssoc(objectInfo){
            // 当前分组下的对象关系
            var objectAssocList = findObjectInArray(buildModel.Product.WorkStationList,
                    [objectInfo.WorkStationID,objectInfo.RefImageID,objectInfo.GroupID])
                    .AssocList;
            // 删除当前对象关系
            var targetIndex;
            for(var i=0;i<objectAssocList.length;i++){
                if(objectInfo.ID == objectAssocList[i].MainNode.Attribute.ID){
                    targetIndex = i;
                    break;
                }
            }
            objectAssocList.splice(targetIndex,1);
        }

        // 更新对象关系数据
        function updateObjectAssoc(item) {
            var groupIds = [selectedNode.parents[0],selectedNode.parents[1],selectedNode.parents[2]];
            var objectIds = [selectedNode.parents[0],selectedNode.parents[1],selectedNode.parents[2]];
            if(selectedNode.nodeType!="object"){
                objectIds.push(selectedNode.parents[3]);
            }else{
                objectIds.push(selectedNode.id);
            }

            // 当前分组下的对象关系
            var objectAssocList = findObjectInArray(buildModel.Product.WorkStationList,groupIds).AssocList;
            // 当前对象
            var currentObject = findObjectInArray(buildModel.Product.WorkStationList,objectIds);

            // 更新对象关系数据
            for(var i=0;i<objectAssocList.length;i++){
                if(currentObject.Attribute.ID == objectAssocList[i].MainNode.Attribute.ID){
                    objectAssocList[i].SubNode[item.id].Attribute.ID = item.value;
                    break;
                }
            }

            // 关联region以黄色填充绘制
            drawAssocRegion(buildModel.Product.WorkStationList,[selectedNode.parents[0],selectedNode.parents[1]],item);
        }

        // 选择关系对象
        function selectAssoc(item){
            var assocItemIndex = item.id.split("-")[1];
            getClickedGraph(callback);
            function callback(clickedGraph){
                console.log("clickedGraph",clickedGraph);

                var objIds = [];
                $.extend(true,objIds,selectedNode.parents);
                if(selectedNode.nodeType == "object"){
                    objIds.push(selectedNode.id);
                }
                var object = findObjectInArray(buildModel.Product.WorkStationList,objIds);

                // 算法关系信息
                var assocList = buildModel.Product.AssocList;
                // 获取关联的算法信息
                var assocInfoList = getAssocInfo(object.Attribute.InspMethodID,assocList);
                // 当前参考图下所有对象信息
                var objectList = getAllObject(selectedNode);

                // 当前对象可选的子对象
                var selectableSubObj = [];
                objectList.forEach(function(object){
                    if(assocInfoList[assocItemIndex].id == object.Attribute.InspMethodID){
                        selectableSubObj.push(object);
                    }
                });

                // 当前对象关系可选的region id
                var selectableGraphIds = [];
                selectableSubObj.forEach(function(obj){
                    if(obj.RegionIDList[0]){
                        selectableGraphIds.push(obj.RegionIDList[0].ID);
                    }
                });

                // 当前对象关系可选的region
                var selectableGraphs = [];
                selectableGraphIds.forEach(function(graphId){
                    graphList.forEach(function(graph){
                        if(graphId == graph.id){
                            selectableGraphs.push(graph);
                        }
                    });
                });

                // 判断点击的region是否在可选的region列表中
                var index = selectableGraphs.indexOf(clickedGraph);
                // 点击的region在列表中
                if(index != -1){
                    var objId;
                    for(var i=0;i<selectableSubObj.length;i++){
                        if(clickedGraph.id == selectableSubObj[i].RegionIDList[0].ID){
                            objId = selectableSubObj[i].Attribute.ID;
                        }
                    }

                    // 更新对象关系数据
                    updateObjectAssoc({
                            id:assocItemIndex,
                            value:objId
                    });

                    // 更新参数界面显示
                    var $assocSelect = eval('$("#'+assocItemIndex+'")');
                    $assocSelect.val(objId);
                }

                console.log("index",index);
            }
        }

        // 黄色填充绘制关联对象区域
        function drawAssocRegion(stationList,imgIds,item){
            // 清除黄色区域
            if(assocGraphs.length != 0){
                if(assocGraphs[item.id]){
                    clearContext("content",assocGraphs[item.id].coverageId);
                    drawGraph(assocGraphs[item.id]);
                }
            }

            var assocObject = findObjectInRefImg(stationList,imgIds,item.value);
            if(assocObject){
                var regionId = assocObject.RegionIDList[0].ID;
                // 根据region id获取相应图形
                var graph = findGraphById(regionId);
                // 以黄色填充重绘
                drawGraph(graph,null,"255,215,0");
                assocGraphs[item.id] = graph;
            }
        }
        // 取消黄色填充绘制关联对象区域
        function restoreAssocRegion(stationList,imgIds,objectId){
            var assocObject = findObjectInRefImg(stationList,imgIds,objectId);
            if(assocObject){
                var regionId = assocObject.RegionIDList[0].ID;
                // 根据region id获取相应图形
                var graph = findGraphById(regionId);
                // 重绘
                drawGraph(graph);
            }
        }

        // 根据界面用户输入，更新对象参数值
        function updateParam(paramItem){
            var ids=[];
            if(selectedNode.nodeType=="object"){
                $.extend(true,ids,selectedNode.parents);
                ids.push(selectedNode.id);
            } else {
                $.extend(true,ids,selectedNode.parents);
            }

            // id
            var id;
            var paramItemIdDetails = paramItem.id.split("-");
            id = paramItemIdDetails[0];
            var type;

            var paramList = findObjectInArray(buildModel.Product.WorkStationList,ids).ParamList;
            for(var i=0;i<paramList.length;i++){
                if(paramList[i].Name == id){
                    paramList[i].Value = paramItem.value;
                    type = paramList[i].Type;
                    break;
                }
            }

            // 参数输入控件联动
            if(type == 10){
                if(paramItemIdDetails[1]=="slider"){
                    eval('$("#'+id+'-spinner").val('+paramItem.value+')');
                }else{
                    eval('$("#'+id+'-slider").val('+paramItem.value+')');
                }
            }

        }

        // 删除对象建模数据
        function deleteObjectBuildModel(selectedNode){
            // 该对象是否有region
            var regionFlag = false;

            var objectId;
            var groupIds;
            if(selectedNode.nodeType=="object"){
                objectId = selectedNode.id;
                groupIds = selectedNode.parents;
            } else{
                objectId = selectedNode.parents[3];
                groupIds = [selectedNode.parents[0],selectedNode.parents[1],selectedNode.parents[2]];
            }
            // 当前分组
            var currentGroup = findObjectInArray(buildModel.Product.WorkStationList,groupIds);

            if(selectedNode.nodeType !="region"){
                // 删除对象数据
                var inspObjList = currentGroup.InspObjList;
                var targetIndex = 0;
                var regionId;
                for(var i=0;i<inspObjList.length;i++){
                    if(inspObjList[i].Attribute.ID == objectId){
                        if(inspObjList[i].RegionIDList.length!=0){
                            regionFlag = true;
                            regionId = inspObjList[i].RegionIDList[0].ID;
                        }
                        targetIndex = i;
                        break;
                    }
                }
                inspObjList.splice(targetIndex,1);
            } else {
                // 删除对象关联的regionID
                var inspObjList = currentGroup.InspObjList;
                for(var i=0;i<inspObjList.length;i++){
                    if(inspObjList[i].Attribute.ID == objectId){
                        if(inspObjList[i].RegionIDList.length!=0){
                            regionFlag = true;
                            inspObjList[i].RegionIDList=[];
                        }
                        break;
                    }
                }
            }

            // 删除region数据
            if(regionFlag){
                var regionList = currentGroup.RegionList;
                var index;
                for(var i=0;i<regionList.length;i++){
                    if(regionList[i].Attribute.ID == regionId){
                        index = i;
                        break;
                    }
                }
                regionList.splice(index,1);
            }
        }

        /*对象、region相关---start----------------------------------------*/
        // 新增对象 新增roi数据至buildModel数据
        function addRegionToBuildModel(graphObject){
            var outer=pointToOuter(graphObject.pointList);
            var region = {
                Attribute:{
                    ID:graphObject.id,
                    NoteID:""
                },
                Outer:outer
            }

            var ids = [];
            var currentGroup;
            $.extend(true,ids,selectedNode.parents);

            // 新增对象
            if(selectedNode.nodeType!="region"){
                // 当前选中的节点是分组
                if(selectedNode.nodeType=="group"){
                    ids.push(selectedNode.id);
                }else if(selectedNode.nodeType=="inspMethod"){ // 当前选中的节点是对象检测方法
                    ids.splice(ids.length-1,1);
                }
                // 分组数据
                currentGroup = findObjectInArray(buildModel.Product.WorkStationList,ids);
                currentGroup.RegionList.push(region);
                // 新增对象
                addObject(graphObject.id);
            }
            // 更新对象region
            if(selectedNode.nodeType=="region"){
                var currentObject = findObjectInArray(buildModel.Product.WorkStationList,ids);
                currentObject.RegionIDList = [{ID:graphObject.id}];
                // 分组数据 RegionList
                ids.splice(ids.length-1,1);
                currentGroup = findObjectInArray(buildModel.Product.WorkStationList,ids);
                currentGroup.RegionList.push(region);
            }
        }

        // 更新建模数据的region
        function updateRegionInBuildModel(graphObject){
            var outer = pointToOuter(graphObject.pointList);

            var workStationList = buildModel.Product.WorkStationList;
            // 寻找使用当前检测区的对象节点
            outerloop:
                    for(var i=0;i<workStationList.length;i++){
                        var workStation = workStationList[i];
                        var refImageList = workStation.RefImageList;
                        for (var j=0;j<refImageList.length;j++){
                            var refImage = refImageList[j];
                            var groupList = refImage.GroupList;
                            for(var k=0;k<groupList.length;k++){
                                var group = groupList[k];
                                var regionList = group.RegionList;
                                for(var l=0;l<regionList.length;l++){
                                    if(regionList[l].Attribute.ID == graphObject.id){
                                        regionList[l].Outer = outer;
                                        break outerloop;
                                    }
                                }
                            }
                        }
                    }
        }

        // 判断是否可以新增roi
        function checkAddRoi(){
            if(selectedNode.nodeType){
                if(selectedNode.nodeType=="workStation"||selectedNode.nodeType=="refImage"){
                    alert("请选择一分组");
                    return false;
                }else if(selectedNode.nodeType=="region"){ // 当前选中节点为对象的region节点
                    var inspObj = findObjectInArray(buildModel.Product.WorkStationList,selectedNode.parents);
                    // 当前对象有region，则不能新增region
                    if(inspObj.RegionIDList.length == 0){
                        return true;
                    }else{
                        alert("请先删除该对象的region！");
                        return false;
                    }
                }else{
                    return true;
                }
            }else{
                alert("请选择一分组");
                return false;
            }
        }

        // 根据当前选中的region选中对象树节点
        function selectNode(currentGraph){
            var idsList = new Array();
            var workStationList = buildModel.Product.WorkStationList;
            // 寻找使用当前检测区的对象节点
            for(var i=0;i<workStationList.length;i++){
                var workStation = workStationList[i];
                var refImageList = workStation.RefImageList;
                for (var j=0;j<refImageList.length;j++){
                    var refImage = refImageList[j];
                    var groupList = refImage.GroupList;
                    for(var k=0;k<groupList.length;k++){
                        var group = groupList[k];
                        var inspObjList = group.InspObjList;
                        for(var l=0;l<inspObjList.length;l++){
                            var inspObj = inspObjList[l];
                            var regionIDList = inspObj.RegionIDList;
                            for(var m=0;m<regionIDList.length;m++){
                                if(regionIDList[m].ID == currentGraph.id){
                                    var ids = [workStation.Attribute.ID,refImage.Attribute.ID,group.Attribute.ID,inspObj.Attribute.ID];
                                    idsList.push(ids);
                                }
                            }
                        }
                    }
                }
            }

            for(var i=0;i<idsList.length;i++){
                var node = findNodeInTreeNode(idsList[i]);
                /*selectedNode.state.selected=false;
                node.state.selected=true;*/

                /*$('#tree').treeview(treeNode);
                treeEvent();*/
                $('#tree').treeview('selectNode', [ node, { silent: true } ]);
                selectedNode = node;
                afterSelecttreeNode();
                // 标识关联对象区域
                markAssocRegion(selectedNode);
            }
        }
        /*对象、region相关---end------------------------------------------*/


        // 显示右侧区域
        function showRightContent(){
            // jquery ui switchClass
            $("#right-content").css( "display", "block");
            $("#center-content").switchClass( "col-md-9", "col-md-6", 500);
            $("#collapse-button").find("i").attr("class","fa fa-angle-double-right");
        }

        // 隐藏右侧区域
        function hideRightContent() {
            $("#right-content").css( "display", "none");
            $("#center-content").switchClass( "col-md-6", "col-md-9", 500);
            $("#collapse-button").find("i").attr("class","fa fa-angle-double-left");
        }
    </script>
</head>
<body>
    <div class="nest-head">
        <!-- tab菜单 -->
        <div class="nest-tab-navbar">
            <ul class="nav nav-tabs" role="tablist">
                <li>
                    <a href="#" class="nest-logo">
                        <img alt="Brand" src="../../standard/image/focusight.png">
                    </a>
                </li>
                <li role="presentation" class="active"><a href="#system" aria-controls="system" role="tab" data-toggle="tab"><i class="fa fa-gears" aria-hidden="true"></i> 系统</a></li>
                <li role="presentation"><a href="#object" aria-controls="object" role="tab" data-toggle="tab"><i class="fa fa-check-square-o" aria-hidden="true"></i> 对象</a></li>
                <li role="presentation"><a href="#auto" aria-controls="auto" role="tab" data-toggle="tab"><i class="fa fa-automobile" aria-hidden="true"></i> 自动</a></li>
                <li role="presentation"><a href="#view" aria-controls="view" role="tab" data-toggle="tab"><i class="fa fa-image" aria-hidden="true"></i> 视图</a></li>
            </ul>
            <!-- 标签面板 -->
            <div class="tab-content nestTabContent">
                <div role="tabpanel" class="tab-pane fade in active" id="system">
                    <!-- tab菜单导航条 -->
                    <nav class="navbar navbar-default nestTabNavbar">
                        <div class="container-fluid">
                            <!-- Brand and toggle get grouped for better mobile display -->
                            <div class="navbar-header">
                                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                                    <span class="sr-only">Toggle navigation</span>
                                    <span class="icon-bar"></span>
                                    <span class="icon-bar"></span>
                                    <span class="icon-bar"></span>
                                </button>
                                <a class="navbar-brand" href="#"></a>
                            </div>

                            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                                <ul class="nav navbar-nav nestNavbarUl">
                                    <li><a href="#" class="nest-nav-label">操作</a></li>
                                    <li><a href="#" id="saveModel"><i class="fa fa-save" aria-hidden="true"></i>保存</a></li>
                                    <li><a href="#"><i class="fa fa-clone" aria-hidden="true"></i>另存为</a></li>
                                    <li><a href="#"><i class="fa fa-trash" aria-hidden="true"></i>删除模板</a></li>
                                    <li><a href="#" id="quit"><i class="fa fa-sign-out" aria-hidden="true"></i>退出</a></li>
                                </ul>
                            </div>
                        </div>
                    </nav>
                </div>
                <div role="tabpanel" class="tab-pane fade" id="object">
                    <!-- tab菜单导航条 -->
                    <nav class="navbar navbar-default nestTabNavbar">
                        <div class="container-fluid">
                            <!-- Brand and toggle get grouped for better mobile display -->
                            <div class="navbar-header">
                                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                                    <span class="sr-only">Toggle navigation</span>
                                    <span class="icon-bar"></span>
                                    <span class="icon-bar"></span>
                                    <span class="icon-bar"></span>
                                </button>
                                <a class="navbar-brand" href="#"></a>
                            </div>

                            <div class="collapse navbar-collapse" id="navbar-collapse-2">
                                <ul class="nav navbar-nav nestNavbarUl">
                                    <li><a href="#" class="nest-nav-label">操作</a></li>
                                    <li><a href="#" id="selectRoi"><i class="fa fa-hand-pointer-o" aria-hidden="true"></i> 选择</a></li>
                                    <li><a href="#" id="deleteRoi"><i class="fa fa-trash" aria-hidden="true"></i> 删除</a></li>
                                </ul>
                                <ul class="nav navbar-nav nestNavbarUl">
                                    <li><a href="#" class="nest-nav-label">ROI</a></li>
                                    <li><a href="#" id="newSquare">矩形</a></li>
                                    <li><a href="#" id="newPolygon">多边形</a></li>
                                </ul>
                            </div>
                        </div>
                    </nav>
                </div>
                <div role="tabpanel" class="tab-pane fade" id="auto">
                    <!-- tab菜单导航条 -->
                    <nav class="navbar navbar-default nestTabNavbar">
                        <div class="container-fluid">
                            <!-- Brand and toggle get grouped for better mobile display -->
                            <div class="navbar-header">
                                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                                    <span class="sr-only">Toggle navigation</span>
                                    <span class="icon-bar"></span>
                                    <span class="icon-bar"></span>
                                    <span class="icon-bar"></span>
                                </button>
                                <a class="navbar-brand" href="#"></a>
                            </div>

                            <div class="collapse navbar-collapse" id="navbar-collapse-3">
                                <ul class="nav navbar-nav nestNavbarUl">
                                    <li><a href="#" class="nest-nav-label">自动功能</a></li>
                                    <li><a href="#"><i class="fa fa-photo" aria-hidden="true"></i> 背景检测区</a></li>
                                    <li><a href="#"><i class="fa fa-picture-o" aria-hidden="true"></i> 前景检测区</a></li>
                                    <li><a href="#"><i class="fa fa-map-marker" aria-hidden="true"></i> 定位核</a></li>
                                    <li><a href="#"><i class="fa fa-gear" aria-hidden="true"></i> 参数设置</a></li>
                                </ul>
                                <ul class="nav navbar-nav nestNavbarUl">
                                    <li><a href="#" class="nest-nav-label">可变信息</a></li>
                                    <li><a href="#"><i class="fa fa-barcode" aria-hidden="true"></i> 一维码</a></li>
                                    <li><a href="#"><i class="fa fa-barcode" aria-hidden="true"></i> 一维字符码</a></li>
                                    <li><a href="#"><i class="fa fa-qrcode" aria-hidden="true"></i> 二维码</a></li>
                                </ul>
                                <ul class="nav navbar-nav nestNavbarUl">
                                    <li><a href="#" class="nest-nav-label">区域</a></li>
                                    <li><a href="#"><i class="fa fa-compress" aria-hidden="true"></i> 腐蚀</a></li>
                                    <li><a href="#"><i class="fa fa-expand" aria-hidden="true"></i> 膨胀</a></li>
                                    <li><a href="#"><i class="fa fa-gear" aria-hidden="true"></i> 参数设置</a></li>
                                </ul>
                            </div>
                        </div>
                    </nav>
                </div>
                <div role="tabpanel" class="tab-pane fade" id="view">
                    <!-- tab菜单导航条 -->
                    <nav class="navbar navbar-default nestTabNavbar">
                        <div class="container-fluid">
                            <!-- Brand and toggle get grouped for better mobile display -->
                            <div class="navbar-header">
                                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                                    <span class="sr-only">Toggle navigation</span>
                                    <span class="icon-bar"></span>
                                    <span class="icon-bar"></span>
                                    <span class="icon-bar"></span>
                                </button>
                                <a class="navbar-brand" href="#"></a>
                            </div>

                            <div class="collapse navbar-collapse" id="navbar-collapse-4">
                                <ul class="nav navbar-nav nestNavbarUl">
                                    <li><a href="#" class="nest-nav-label">适应</a></li>
                                    <li><a href="#" id="fitOrigin"><i class="fa fa-image" aria-hidden="true"></i> 原始图像</a></li>
                                    <li><a href="#" id="fitWidth"><i class="fa fa-arrows-h" aria-hidden="true"></i> 适应宽度</a></li>
                                    <li><a href="#" id="fitHeight"><i class="fa fa-arrows-v" aria-hidden="true"></i> 适应高度</a></li>
                                    <li><a href="#" id="fitWindow"><i class="fa fa-arrows-alt" aria-hidden="true"></i> 适应窗口</a></li>
                                </ul>
                                <ul class="nav navbar-nav nestNavbarUl">
                                    <li><a href="#" class="nest-nav-label">缩放</a></li>
                                    <li><a href="#" id="zoomIn"><i class="fa fa-search-plus" aria-hidden="true"></i> 放大</a></li>
                                    <li><a href="#" id="zoomOut"><i class="fa fa-search-minus" aria-hidden="true"></i> 缩小</a></li>
                                </ul>
                                <ul class="nav navbar-nav nestNavbarUl">
                                    <li><a href="#" class="nest-nav-label">元素</a></li>
                                    <li><a href="#"><i class="fa fa-square" aria-hidden="true"></i> 显示掩膜</a></li>
                                    <li><a href="#"><i class="fa fa-square-o" aria-hidden="true"></i> 动态边框</a></li>
                                </ul>
                            </div>
                        </div>
                    </nav>
                </div>
            </div>
        </div>
    </div>


    <!--主体内容-->
    <div class="nest-content">
        <div class="container-fluid">
            <a class="btn btn-default" href="#" role="button" id="collapse-button"><i class="fa fa-angle-double-left"></i></a>
            <div class="row">
                <!--布局左侧内容-->
                <div class="col-md-3 nestCol">
                    <div class="nest-section">
                        <div class="btn-toolbar" role="toolbar" aria-label="..." id="btnToolbar">
                            <div class="btn-group btn-group-sm nest-btn-group" role="group" aria-label="...">
                                <button type="button" class="btn btn-default" id="collapse"><i class="fa fa-minus"></i></button>
                            </div>
                            <div class="btn-group btn-group-sm nest-btn-group" role="group" id="imageToolbar" style="display: none">
                                <button type="button" class="btn btn-info btnTooltip" title="增加分组" id="addGroup"><i class="fa fa-plus-square"></i></button>
                            </div>
                            <div class="btn-group btn-group-sm nest-btn-group" role="group" id="groupToolbar" style="display: none">
                                <button type="button" class="btn btn-info btnTooltip" title="增加对象" id="addObject"><i class="fa fa-plus-square"></i></button>
                                <button type="button" class="btn btn-danger btnTooltip" title="删除分组" id="deleteGroup"><i class="fa fa-trash"></i></button>
                            </div>
                            <div class="btn-group btn-group-sm nest-btn-group" role="group" id="objectToolbar" style="display: none">
                                <button type="button" class="btn btn-danger btnTooltip" title="删除对象" id="deleteObject"><i class="fa fa-trash"></i></button>
                            </div>
                        </div>
                        <div id="treeContainer" style="overflow: auto;">
                            <div id="tree"></div>
                        </div>
                    </div>
                </div>
                <!--布局中间内容-->
                <div class="col-md-9 nestCol" id="center-content">
                    <div class="nest-section">
                        <div id="canvas_container" class="canvas_container" style="position: relative;width: 100%;height: 100%;">
                            <canvas id="canvas_compress" class="absoluteCenter" style="position: absolute;z-index: 1;display: none"></canvas>
                            <canvas id="canvas_bg" class="absoluteCenter" style="position: absolute;z-index: 1;background-color: #0a0a0a;"></canvas>
                            <canvas id="canvas_bak" class="absoluteCenter" style="position: absolute;z-index: 1;"></canvas>
                        </div>
                    </div>
                </div>
                <!--布局右侧内容-->
                <div class="col-md-3 nestCol" id="right-content" style="display: none">
                    <div class="nest-section">
                        <!--面板-->
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title" id="objectName">对象#1</h3>
                            </div>
                            <div class="panel-body" style="padding: 5px">
                                <form class="form-horizontal nest-small-form">
                                    <div class="form-group">
                                        <div class="col-sm-12">
                                            <select class="form-control" id="algorithm-select"></select>
                                        </div>
                                    </div>

                                    <div class="well" id="assocContainer" style="padding: 5px"></div>

                                    <div class="nest-small-tab">
                                        <!-- Nav tabs -->
                                        <ul class="nav nav-tabs" role="tablist">
                                            <li class="dropdown active">
                                                <a href="#" id="myTabDrop1" class="dropdown-toggle"
                                                   data-toggle="dropdown">基本参数
                                                    <b class="caret"></b>
                                                </a>
                                                <ul class="dropdown-menu" role="menu" aria-labelledby="myTabDrop1" id="basic-dropdown-menu"></ul>
                                            </li>
                                            <li class="dropdown">
                                                <a href="#" id="myTabDrop2" class="dropdown-toggle"
                                                   data-toggle="dropdown">高级参数
                                                    <b class="caret"></b>
                                                </a>
                                                <ul class="dropdown-menu" role="menu" aria-labelledby="myTabDrop2" id="advance-dropdown-menu"></ul>
                                            </li>
                                            <li role="presentation"><a href="#debugParam" aria-controls="messages" role="tab" data-toggle="tab">调试结果</a></li>
                                            <!--<li role="presentation"><button class="btn btn-default btn-xs" id="paramDebug" type="button" style="margin-top: 3px">调试</button></li>-->
                                        </ul>

                                        <!-- Tab panes -->
                                        <div class="tab-content" id="tab-content">
                                            <div role="tabpanel" class="tab-pane" id="debugParam">调试结果</div>
                                        </div>

                                    </div>

                                </form>

                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="nest-footer">
        <nav class="navbar navbar-default nestStepChangeBar">
            <div class="container-fluid">
                <div class="navbar-form">
                    <button class="btn btn-default nestStepChangeBarLeftButton" id="prevStep"><i class="fa fa-chevron-left"></i> 上一步</button>
                    <button class="btn btn-default nestStepChangeBarRightButton" id="nextStep">下一步 <i class="fa fa-circle-o"></i></button>
                </div>
            </div>
        </nav>
    </div>
</body>

<!--加载中-->
<div class="modal fade" id="canvasLoadingModal" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true" style="top: 30%;">
    <div class="modal-dialog" style="height: 50px;width: 300px">
        <div class="modal-content" style="border-radius: 3px;">
            <div class="modal-body">
                <i class="fa fa-spinner fa-spin fa-2x" style="margin-left: 90px;"></i>加载中......
            </div>
        </div>
    </div>
</div>

</html>